<!DOCTYPE html>
<html>
<head>
    <title>Pump Control</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .section { 
            margin-bottom: 20px; 
            padding: 15px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            opacity: 0.8;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: black;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        label { 
            display: block; 
            margin-top: 8px; 
            font-weight: bold;
        }
        input[type="number"], input[type="time"] {
            width: 150px;
            padding: 5px;
            margin-top: 3px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .checkbox-group {
            margin-top: 8px;
        }
        .checkbox-group label {
            display: inline-block;
            margin-right: 15px;
            font-weight: normal;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 18px;
        }
        .status.on {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.off {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 16px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-width: 400px;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
    </style>
    <script>
        function showMessage(message, isError = false) {
            const existing = document.getElementById('message');
            if (existing) existing.remove();
            
            const div = document.createElement('div');
            div.id = 'message';
            div.className = 'message ' + (isError ? 'error' : 'success');
            div.textContent = message;
            document.body.appendChild(div);
            
            console.log(`Showing message: ${message} (error: ${isError})`);
            
            setTimeout(() => {
                if (div.parentNode) {
                    div.style.opacity = '0';
                    div.style.transition = 'opacity 0.3s';
                    setTimeout(() => div.remove(), 300);
                }
            }, 4000);
        }

        function sendForm(formId) {
            const form = document.getElementById(formId);
            if (!form) {
                showMessage('Form not found: ' + formId, true);
                return false;
            }
            
            const data = new FormData(form);
            
            // Debug: log form data
            console.log(`Sending form data from ${formId}:`);
            for (let [key, value] of data.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            
            // Disable form to prevent double submission
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
            }
            
            // Create abort controller for timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            fetch("/update", { 
                method: "POST", 
                body: data,
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(responseData => {
                    console.log('Server response:', responseData);
                    if (responseData && responseData.status === 'success') {
                        showMessage(`Settings saved successfully!`);
                        // Update the displayed config
                        updateConfigDisplay(responseData.config);
                    } else {
                        showMessage('Error: ' + (responseData?.message || 'Unknown server error'), true);
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('Error:', error);
                    if (error.name === 'AbortError') {
                        showMessage('Request timed out - please try again', true);
                    } else {
                        showMessage('Error saving settings: ' + error.message, true);
                    }
                })
                .finally(() => {
                    // Re-enable form
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        if (formId === 'pumpForm') {
                            submitBtn.textContent = 'Save Pump Settings';
                        } else if (formId === 'scheduleForm') {
                            submitBtn.textContent = 'Save Schedule Settings';
                        }
                    }
                });
            return false;
        }

        function togglePump() {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Processing...';
            
            // Create abort controller for timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
            
            fetch("/toggle", { 
                method: "POST",
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log('Toggle response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Toggle response:', data);
                    if (data && data.status === 'success') {
                        showMessage('Manual pump toggled successfully!');
                        // Update button text
                        button.textContent = data.manual_on ? 'Stop Manual Pump' : 'Start Manual Pump';
                        button.className = data.manual_on ? 'btn-warning' : 'btn-primary';
                    } else {
                        showMessage('Error toggling pump: ' + (data?.message || 'Unknown server error'), true);
                        button.textContent = originalText;
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('Error:', error);
                    button.textContent = originalText;
                    if (error.name === 'AbortError') {
                        showMessage('Request timed out - please try again', true);
                    } else {
                        showMessage('Error toggling pump: ' + error.message, true);
                    }
                })
                .finally(() => {
                    button.disabled = false;
                });
        }

        function toggleFlush() {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Processing...';
            
            // Create abort controller for timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
            
            fetch("/toggle_flush", { 
                method: "POST",
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log('Flush toggle response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Flush toggle response:', data);
                    if (data && data.status === 'success') {
                        showMessage('Flush mode toggled successfully!');
                        // Update button text
                        button.textContent = data.flush_on ? 'Stop Flush Mode' : 'Start Flush Mode';
                        button.className = data.flush_on ? 'btn-danger' : 'btn-warning';
                    } else {
                        showMessage('Error toggling flush: ' + (data?.message || 'Unknown server error'), true);
                        button.textContent = originalText;
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('Error:', error);
                    button.textContent = originalText;
                    if (error.name === 'AbortError') {
                        showMessage('Request timed out - please try again', true);
                    } else {
                        showMessage('Error toggling flush: ' + error.message, true);
                    }
                })
                .finally(() => {
                    button.disabled = false;
                });
        }

        function testServer() {
            console.log('Testing server connection...');
            showMessage('Testing server...');
            
            fetch("/test", { method: "POST" })
                .then(response => {
                    console.log('Test response:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Test data:', data);
                    showMessage('Server test successful: ' + data.message);
                })
                .catch(error => {
                    console.error('Test error:', error);
                    showMessage('Server test failed: ' + error.message, true);
                });
        }

        function shutdownPi() {
            if (confirm("Really shut down the Raspberry Pi?")) {
                fetch("/shutdown", { method: "POST" })
                    .then(response => response.json())
                    .then(data => {
                        showMessage("Shutting down...");
                    })
                    .catch(error => {
                        showMessage('Error shutting down: ' + error.message, true);
                    });
            }
        }

        function updateConfigDisplay(config) {
            const configEl = document.getElementById('config-display');
            if (configEl && config) {
                configEl.textContent = JSON.stringify(config, null, 2);
            }
        }

        // Auto-refresh status every 30 seconds
        function refreshStatus() {
            fetch("/status")
                .then(response => response.json())
                .then(data => {
                    console.log('Status update:', data);
                    const statusEl = document.getElementById('pump-status');
                    if (statusEl) {
                        statusEl.textContent = 'Pump Status: ' + (data.pump_active ? 'ON' : 'OFF');
                        statusEl.className = 'status ' + (data.pump_active ? 'on' : 'off');
                    }
                    
                    // Update manual control buttons
                    updateManualButtons(data);
                    
                    // Update config display
                    updateConfigDisplay(data.config);
                })
                .catch(error => console.log('Status refresh failed:', error));
        }
        
        function updateManualButtons(data = null) {
            // If no data provided, fetch it
            if (!data) {
                fetch("/status")
                    .then(response => response.json())
                    .then(statusData => updateManualButtons(statusData))
                    .catch(error => console.log('Failed to fetch status for button update:', error));
                return;
            }
            
            const manualBtn = document.getElementById('manual-pump-btn');
            const flushBtn = document.getElementById('flush-btn');
            
            if (manualBtn) {
                manualBtn.textContent = data.manual_on ? 'Stop Manual Pump' : 'Start Manual Pump';
                manualBtn.className = data.manual_on ? 'btn-warning' : 'btn-primary';
            }
            
            if (flushBtn) {
                flushBtn.textContent = data.flush_on ? 'Stop Flush Mode' : 'Start Flush Mode';
                flushBtn.className = data.flush_on ? 'btn-danger' : 'btn-warning';
            }
        }

        // Initialize on page load
        function initializePage() {
            fetch("/status")
                .then(response => response.json())
                .then(data => {
                    // Update status
                    const statusEl = document.getElementById('pump-status');
                    if (statusEl) {
                        statusEl.textContent = 'Pump Status: ' + (data.pump_active ? 'ON' : 'OFF');
                        statusEl.className = 'status ' + (data.pump_active ? 'on' : 'off');
                    }
                    
                    // Update forms with current config
                    if (data.config) {
                        // Update pump form
                        document.querySelector('input[name="interval_ms"]').value = data.config.interval_ms || 5000;
                        document.querySelector('input[name="on_duration_ms"]').value = data.config.on_duration_ms || 2000;
                        document.querySelector('input[name="fade_time_ms"]').value = data.config.fade_time_ms || 1000;
                        document.querySelector('input[name="pump_speed_min"]').value = data.config.pump_speed_min || 0.0;
                        document.querySelector('input[name="pump_speed_max"]').value = data.config.pump_speed_max || 1.0;
                        
                        // Update schedule form
                        document.querySelector('input[name="start_time"]').value = data.config.start_time || "00:00";
                        document.querySelector('input[name="end_time"]').value = data.config.end_time || "23:59";
                        
                        // Update checkboxes
                        const activeDays = data.config.active_days || [];
                        document.querySelectorAll('input[name="active_days"]').forEach(checkbox => {
                            checkbox.checked = activeDays.includes(checkbox.value);
                        });
                        
                        document.querySelector('input[name="enabled"]').checked = data.config.enabled !== false;
                        
                        // Update config display
                        updateConfigDisplay(data.config);
                    }
                    
                    // Update buttons
                    updateManualButtons(data);
                })
                .catch(error => {
                    console.error('Failed to initialize page:', error);
                    showMessage('Failed to load current configuration', true);
                });
        }

        // Refresh status every 30 seconds
        setInterval(refreshStatus, 30000);
        
        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</head>
<body>
    <h1>Pump Control Interface</h1>
    
    <div id="pump-status" class="status off">
        Pump Status: Loading...
    </div>
    
    <div class="section">
        <h2>Manual Control</h2>
        <button id="manual-pump-btn" class="btn-primary" onclick="togglePump()">
            Start Manual Pump
        </button>
        <button id="flush-btn" class="btn-warning" onclick="toggleFlush()">
            Start Flush Mode
        </button>
    </div>

    <div class="section">
        <h2>Pump Settings</h2>
        <form id="pumpForm" onsubmit="return sendForm('pumpForm');">
            <label>Interval (ms): 
                <input type="number" name="interval_ms" value="5000" min="1000" step="100">
            </label>
            <label>On Duration (ms): 
                <input type="number" name="on_duration_ms" value="2000" min="100" step="100">
            </label>
            <label>Fade Time (ms): 
                <input type="number" name="fade_time_ms" value="1000" min="0" step="100">
            </label>
            <label>Min Speed (0.0-1.0): 
                <input type="number" step="0.1" name="pump_speed_min" value="0.0" min="0" max="1">
            </label>
            <label>Max Speed (0.0-1.0): 
                <input type="number" step="0.1" name="pump_speed_max" value="1.0" min="0" max="1">
            </label>
            <br><br>
            <button type="submit" class="btn-success">Save Pump Settings</button>
        </form>
    </div>

    <div class="section">
        <h2>Schedule Settings</h2>
        <form id="scheduleForm" onsubmit="return sendForm('scheduleForm');">
            <label>Start Time: 
                <input type="time" name="start_time" value="00:00">
            </label>
            <label>End Time: 
                <input type="time" name="end_time" value="23:59">
            </label>
            
            <label>Active Days:</label>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" name="active_days" value="Mon" checked> Mon
                </label>
                <label>
                    <input type="checkbox" name="active_days" value="Tue" checked> Tue
                </label>
                <label>
                    <input type="checkbox" name="active_days" value="Wed" checked> Wed
                </label>
                <label>
                    <input type="checkbox" name="active_days" value="Thu" checked> Thu
                </label>
                <label>
                    <input type="checkbox" name="active_days" value="Fri" checked> Fri
                </label>
                <label>
                    <input type="checkbox" name="active_days" value="Sat" checked> Sat
                </label>
                <label>
                    <input type="checkbox" name="active_days" value="Sun" checked> Sun
                </label>
            </div>
            
            <label>
                <input type="checkbox" name="enabled" value="true" checked> System Enabled
            </label>
            <br><br>
            <button type="submit" class="btn-success">Save Schedule Settings</button>
        </form>
    </div>

    <div class="section">
        <h2>System Control</h2>
        <button class="btn-success" onclick="testServer()">Test Server Connection</button>
        <button class="btn-danger" onclick="shutdownPi()">SHUTDOWN RASPBERRY PI</button>
    </div>

    <div class="section">
        <h3>Current Configuration</h3>
        <pre id="config-display" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px;">Loading...</pre>
    </div>
</body>
</html>
